<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師研習資訊神提取系統</title> <!-- 靜態定義的瀏覽器標題 -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- pdf.js (for reading PDFs) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <!-- Tesseract.js (for OCR on images) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        /* Base and Dark Mode Variables */
        :root {
            --bg-color: #f4f7f9;
            --panel-bg: #ffffff;
            --text-color: #333;
            --heading-color: #2c3e50;
            --muted-color: #7f8c8d;
            --primary-color: #2563eb; /* Tailwind blue-600 */
            --primary-hover: #1d4ed8; /* Tailwind blue-700 */
            --secondary-color: #4b5563; /* For buttons like Markdown copy */
            --secondary-hover: #1f2937;
            --border-color: #e3e8ee;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --skeleton-bg: #e0e0e0;
            --font-ui: 'Poppins', 'Noto Sans TC', sans-serif;
            --font-body: 'Noto Sans TC', serif;
        }

        [data-theme="dark"] {
            --bg-color: #2c3e50;
            --panel-bg: #34495e;
            --text-color: #ecf0f1; /* Light text for dark mode */
            --heading-color: #ffffff;
            --muted-color: #95a5a6;
            --border-color: #4b6584;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --skeleton-bg: #4a627a;
            --input-bg: #4a5c70; /* Darker input background */
            --input-text: #ecf0f1; /* Light text for inputs */
            --input-border: #627b91; /* Border for inputs */
        }

        /* Base Body Styles */
        html {
            /* 允許整個 HTML 根元素滾動，預設情況下 body 的滾動條會在 html 上顯示 */
            overflow-y: auto; 
            overflow-x: hidden; /* 隱藏水平滾動條 */
        }

        body { 
            font-family: var(--font-ui); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: background-color 0.3s, color 0.3s; 
            line-height: 1.6; 
            min-height: 100vh; /* 確保 body 至少佔滿視窗高度 */
            display: flex;
            flex-direction: column;
            position: relative; /* For floating emojis */
            /* 移除 body 上的 overflow: hidden; */
            /* 讓 HTML 元素來處理滾動，或者將 body 設置為 auto */
            /* 如果 body 內容超過 100vh，則允許滾動 */
            overflow-y: auto; 
            overflow-x: hidden; /* 保持隱藏 body 內的水平滾動，避免與 HTML 衝突 */
        }

        .container { flex-grow: 1; z-index: 10; position: relative; } /* Allow container to grow, pushing footer down, put above emojis */

        /* Panel Styles */
        .panel { 
            background: var(--panel-bg); 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border-color); 
            transition: background-color 0.3s, border-color 0.3s; 
            display: flex; 
            flex-direction: column; 
        }
        .panel-header { 
            font-size: 1.5rem; 
            font-weight: 600; 
            color: var(--heading-color); 
            margin-bottom: 20px; 
        }

        /* Buttons */
        .btn { 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
            font-weight: 500; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            border: 1px solid transparent; 
        }
        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
        }
        .btn-primary:hover:not(:disabled) { 
            background: var(--primary-hover); 
            border-color: var(--primary-hover); 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .btn-secondary-custom { /* For Markdown copy button */
            background: var(--secondary-color); 
            color: white; 
            border-color: var(--secondary-color); 
            padding: 0.5rem 1rem; /* Smaller padding for inline buttons */
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        .btn-secondary-custom:hover:not(:disabled) { 
            background: var(--secondary-hover); 
            border-color: var(--secondary-hover); 
            transform: translateY(-1px); /* Slightly less aggressive hover */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .btn-outline { 
            background: none; 
            border-color: var(--border-color); 
            color: var(--text-color); 
        }
        .btn-outline:hover:not(:disabled) { 
            background: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
        }
        .btn:disabled { 
            background: var(--muted-color); 
            color: #fff; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
            border-color: var(--muted-color); 
        }

        /* Drop Zone */
        #drop-zone { 
            border: 2px dashed var(--border-color); 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            text-align: center; 
            transition: all 0.3s ease; 
            background-color: var(--bg-color); 
            cursor: pointer; 
            position: relative; /* Essential for overlaying file input */
            overflow: hidden; 
        }
        #drop-zone.drag-over { 
            border-color: var(--primary-color); 
            background-color: var(--bg-color); 
        }
        /* File input covers drop-zone, is transparent and functional for both click and drag/drop */
        #file-upload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; /* Fully transparent */
            cursor: pointer;
            z-index: 10; /* Ensure it's above other drop-zone content for clicks */
            pointer-events: auto; /* Crucial for ensuring it receives pointer events */
        }
        
        /* Modals */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            animation: fadeIn 0.3s; 
        }
        /* Custom modal for API key tutorial - ensure dark mode compatibility */
        .modal-content-custom { 
            background: var(--panel-bg); 
            padding: 30px; 
            border-radius: 16px; 
            max-width: 600px; 
            width: 90%; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            max-height: 80vh; 
            overflow-y: auto; 
            color: var(--text-color); /* Apply theme text color */
        } 
        .modal-close { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            font-size: 1.8rem; 
            color: var(--muted-color); 
            cursor: pointer; 
            transition: transform 0.2s; 
        }
        .modal-close:hover { 
            transform: scale(1.2); 
        }
        .modal-content-custom a { 
            color: var(--primary-color); 
            text-decoration: none; 
        }
        .modal-content-custom a:hover { 
            text-decoration: underline; 
        }

        /* Theme Switcher */
        .theme-switcher {
            position: absolute; 
            top: 50%; 
            right: 0; 
            transform: translateY(-50%);
            background: var(--panel-bg); 
            border: 1px solid var(--border-color);
            border-radius: 50px; 
            padding: 5px; 
            cursor: pointer; 
            font-size: 1.2rem;
            width: 40px; 
            height: 40px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            transition: all 0.3s; 
            color: var(--text-color);
        }
        .theme-switcher:hover { 
            transform: translateY(-50%) scale(1.1) rotate(15deg); 
        }

        /* Mascot */
        #mascot {
            position: fixed;
            bottom: 15px;
            left: 15px;
            width: clamp(80px, 12vw, 120px);
            z-index: 998;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.2));
        }
        #mascot:hover {
            transform: scale(1.1);
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: scale(1.1) translate3d(-1px, 0, 0); }
            20%, 80% { transform: scale(1.1) translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: scale(1.1) translate3d(-3px, 0, 0); }
            40%, 60% { transform: scale(1.1) translate3d(3px, 0, 0); }
        }
        .particle {
            position: fixed;
            pointer-events: none;
            border-radius: 50%;
            opacity: 0;
            z-index: 1001;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) { #mascot { width: 80px; } }

        /* General form input styling */
        .form-control { 
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--panel-bg); /* Match panel background */
            color: var(--text-color); /* Match theme text color */
            transition: all 0.2s ease-in-out;
        }
        .form-control:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); 
            border-color: var(--primary-color);
        }
        /* Dark mode specific for form controls */
        [data-theme="dark"] .form-control {
            background-color: var(--input-bg);
            color: var(--input-text);
            border-color: var(--input-border);
        }
        
        /* Markdown Output Textarea */
        #markdown-output {
            resize: vertical; /* Allow vertical resizing */
            min-height: 150px; /* Minimum height */
            font-family: 'Noto Sans TC', monospace; /* More readable font for text content, monospace for code-like */
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            height: 100%; /* Fill available height */
        }

        /* Dark mode compatibility for specific text elements */
        header h1 {
            color: var(--heading-color);
        }
        header p {
            color: var(--muted-color);
        }
        #status-log {
            background-color: var(--input-bg); /* Use input background for log */
            color: var(--input-text); /* Ensure base text color is light in dark mode for any direct content */
            border-color: var(--border-color);
            /* Custom scrollbar for Webkit browsers */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--primary-color) var(--input-bg); /* Firefox scrollbar color */
        }
        #status-log::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
            height: 8px; /* Height of horizontal scrollbar */
        }
        #status-log::-webkit-scrollbar-track {
            background: var(--input-bg); /* Track background */
            border-radius: 10px;
        }
        #status-log::-webkit-scrollbar-thumb {
            background: var(--primary-color); /* Scrollbar thumb color */
            border-radius: 10px;
            border: 2px solid var(--input-bg); /* Add border for better contrast with track */
        }
        #status-log::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover); /* Hover color */
        }

        /* API Key label text color override */
        label[for="user-api-key"] {
            color: var(--text-color); /* Ensure this label uses theme text color */
        }
        /* API Key Modal text to ensure readability in dark mode */
        #api-key-modal .modal-content-custom .space-y-3 p,
        #api-key-modal .modal-content-custom ol li,
        #api-key-modal .modal-content-custom strong {
            color: var(--text-color); 
        }
        #api-key-modal .modal-content-custom a {
             color: var(--primary-color);
        }
        #api-key-modal .modal-content-custom .text-yellow-700 {
            /* In dark mode, ensure this is a bright variant of yellow */
            color: var(--text-color); /* Change to theme text color to ensure readability */
        }
        #api-key-modal .modal-content-custom .bg-yellow-50 {
            background-color: var(--input-bg); /* Make warning background dark */
        }

        /* Floating Emojis */
        #floating-emojis-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Do not block interaction with content */
            z-index: 1; /* Below content, above body background */
            overflow: hidden; /* **關鍵修正：將溢出隱藏在這裡，防止 emoji 影響 body 滾動** */
        }

        .floating-emoji {
            position: absolute;
            font-size: clamp(1.5rem, 3vw, 3rem); /* Responsive font size */
            opacity: 0;
            animation: float-up linear forwards;
            white-space: nowrap; /* Prevent emoji from wrapping */
            transform-origin: bottom center; /* For rotation */
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.1)); /* Subtle shadow for visibility */
            /* Removed default color here, using inline Tailwind colors for variety */
        }

        @keyframes float-up {
            0% {
                transform: translateY(0vh) scale(0.5) rotateZ(0deg);
                opacity: 0;
            }
            20% {
                opacity: 0.8;
            }
            80% {
                opacity: 0.8;
                transform: translateY(-80vh) scale(1.0) rotateZ(360deg);
            }
            100% {
                transform: translateY(-100vh) scale(1.2) rotateZ(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="text-gray-800" data-theme="light">

    <!-- Floating Emojis Container -->
    <div id="floating-emojis-container"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8 text-center relative">
            <h1 class="text-4xl font-bold mb-2 flex items-center justify-center gap-3"><i class="fa-solid fa-chalkboard-user text-blue-600"></i>教師研習資訊神提取系統</h1>
            <p class="text-lg">智慧分析 PDF/圖片文件，自動神提取教師研習資訊</p>
            <button class="theme-switcher" id="theme-toggle" title="切換主題"><i class="fa-solid fa-sun"></i></button>
        </header>

        <div id="ai-panel-container"> <!-- This container is always visible -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Panel: Upload and Settings -->
                <section class="panel upload-panel">
                    <h2 class="panel-header">上傳檔案與設定</h2>
                    <div id="drop-zone" class="mb-4">
                        <i class="fas fa-file-arrow-up text-5xl text-blue-500 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-300">將 PDF/圖片 檔案拖曳至此，或點擊選擇 (可多選)</p>
                        <!-- File input covers the drop zone, is transparent and functional -->
                        <input type="file" id="file-upload" accept=".pdf,image/*" multiple> 
                    </div>

                    <div id="file-list" class="space-y-2 mb-4">
                        <!-- Uploaded file items will be inserted here -->
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label for="user-api-key" class="font-medium text-gray-700 dark:text-gray-200">Google Gemini API 金鑰</label>
                            <span id="api-tutorial-link" class="text-sm text-blue-600 hover:underline cursor-pointer">(如何取得？)</span>
                        </div>
                        <input type="password" id="user-api-key" placeholder="貼上您的 API 金鑰" class="form-control">
                        <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">金鑰僅儲存在您的瀏覽器中，不會上傳至任何伺服器。</p>
                    </div>
                    
                    <div class="mt-auto pt-6 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-4">
                        <button id="clear-all-btn" class="btn btn-outline flex-grow">
                            <i class="fa-solid fa-eraser"></i> 清空所有
                        </button>
                        <button id="start-extraction-btn" class="btn btn-primary flex-grow text-lg" disabled>
                            <i class="fa-solid fa-brain"></i> 開始AI神提取
                        </button>
                    </div>

                    <div class="border-t pt-4 mt-6">
                        <label for="user-api-key" class="font-medium text-gray-700 dark:text-gray-200">處理狀態</label>
                        <!-- 確保 h-32 提供固定高度，且 overflow-y-auto 啟用滾動 -->
                        <div id="status-log" class="w-full h-32 p-3 border border-gray-200 rounded-lg font-mono text-sm overflow-y-auto">
                            <!-- 初始訊息會由 JS 寫入 -->
                        </div>
                    </div>
                </section>

                <!-- Right Panel: AI Output Editor and Download -->
                <section class="panel results-panel">
                    <h2 class="panel-header">AI神提取結果</h2>
                    <!-- Markdown Output Area -->
                    <div class="flex-grow flex flex-col space-y-4">
                        <textarea id="markdown-output" class="form-control flex-grow" rows="15" placeholder="AI神提取結果將以 Markdown 格式顯示於此，您可以編輯後複製..."></textarea>
                        <button id="copy-markdown-btn" class="btn btn-secondary-custom">
                            <i class="fa-solid fa-clipboard"></i> 複製 Markdown
                        </button>
                    </div>
                </section>
            </div>
        </div>

    </div>
    
    <footer class="text-center mt-10 text-gray-500 dark:text-gray-400 text-sm pb-6">Copyright © Liyuchiutiger Gongminshen</footer>

    <img id="mascot" src="image/LiyuChillGuy.svg" alt="LiyuChillGuy Mascot">

    <!-- API Key Modal -->
    <div class="modal-overlay" id="api-key-modal">
        <div class="modal-content-custom">
            <span class="modal-close" id="api-key-modal-close">&times;</span>
            <h3 class="text-xl font-bold text-blue-600 mb-4">如何取得免費的 Google Gemini API 金鑰？</h3>
            <div class="space-y-3"> 
                <p>按照以下簡單步驟，即可取得您自己的免費金鑰：</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li>前往 <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-semibold">Google AI Studio 的 API 金鑰頁面</a>。</li>
                    <li>使用您的 Google 帳號登入。</li>
                    <li>點擊頁面上的 <strong>「建立 API 金鑰」(Create API key)</strong> 按鈕。</li>
                    <li>系統會立即產生一組新的金鑰。點擊金鑰旁邊的複製圖示。</li>
                    <li>回到本頁面，將複製的金鑰貼到輸入框中即可！</li>
                </ol>
                <p class="text-sm text-yellow-700 bg-yellow-50 p-3 rounded-lg dark:bg-yellow-900 dark:text-yellow-200">
                    <strong>提醒：</strong>請妥善保管您的 API 金鑰，不要與他人分享。AI 服務會消耗一定的額度。
                </p>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    'use strict';

    const ui = {
        themeToggle: document.getElementById('theme-toggle'),
        dropZone: document.getElementById('drop-zone'),
        fileUpload: document.getElementById('file-upload'), 
        fileList: document.getElementById('file-list'),
        apiKeyInput: document.getElementById('user-api-key'),
        statusLog: document.getElementById('status-log'),
        startExtractionBtn: document.getElementById('start-extraction-btn'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        apiKeyModal: document.getElementById('api-key-modal'),
        openApiKeyModalLink: document.getElementById('api-tutorial-link'),
        closeApiKeyModalBtn: document.getElementById('api-key-modal-close'),
        mascot: document.getElementById('mascot'),
        markdownOutput: document.getElementById('markdown-output'), // Reference to the textarea
        copyMarkdownBtn: document.getElementById('copy-markdown-btn'), // Reference to copy button
        floatingEmojisContainer: document.getElementById('floating-emojis-container'), // Floating emojis container
    };

    const state = {
        files: new Map(), // Map<id, { file: File, id: string, status: string, text: string | null, data: object[] | null }>
        fileIdCounter: 0,
        allExtractedResults: [], // Holds results from AI before displaying
        currentUser: { name: '匿名使用者', role: '公開使用者' } // For console logging
    };

    const libraries = {
        pdfjsLib: window.pdfjsLib,
        Tesseract: window.Tesseract,
    };

    // --- Mascot & Theme Toggle Logic ---
    const audioManager = { 
        ctx: null,
        init: function() {
            try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } 
            catch (e) { console.error("Web Audio API is not supported."); this.ctx = null; }
        },
        _playSoundNode: function(type, frequency, duration, volume, rampTargetFreq) {
            if (!this.ctx) return;
            const oscillator = this.ctx.createOscillator();
            const gainNode = this.ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(this.ctx.destination);
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, this.ctx.currentTime);
            if (rampTargetFreq) oscillator.frequency.linearRampToValueAtTime(rampTargetFreq, this.ctx.currentTime + duration * 0.8);
            gainNode.gain.setValueAtTime(volume, this.ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
            oscillator.start(this.ctx.currentTime);
            oscillator.stop(this.ctx.currentTime + duration);
        },
        play: async function(soundName) {
            if (!this.ctx) return;
            if (this.ctx.state === 'suspended') { try { await this.ctx.resume(); } catch (e) { console.error("Failed to resume AudioContext:", e); return; } }
            if (soundName === 'sparkle') {
                this._playSoundNode('triangle', 1500, 0.1, 0.07, 2500);
                setTimeout(() => this._playSoundNode('sine', 2000, 0.1, 0.05), 80);
            }
        }
    };
    audioManager.init();

    function createParticles(x, y) {
        const particleCount = 20;
        const colors = ['#3498db', '#2ecc71', '#f1c40f', '#9b59b6']; 
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            document.body.appendChild(particle);
            const size = Math.random() * 8 + 5; 
            particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            const angle = Math.random() * Math.PI * 2;
            const distance = Math.random() * 80 + 50; 
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            particle.style.left = `${x - size / 2}px`;
            particle.style.top = `${y - size / 2}px`;
            const animation = particle.animate(
                [{ transform: 'translate(0, 0) scale(1)', opacity: 1 }, { transform: `translate(${endX}px, ${endY}px) scale(0)`, opacity: 0 }],
                { duration: Math.random() * 600 + 400, easing: 'cubic-bezier(0.1, 0.9, 0.2, 1)', fill: 'forwards' }
            );
            animation.onfinish = () => particle.remove();
        }
    }

    if (ui.mascot) {
        ui.mascot.addEventListener('click', (e) => {
            audioManager.play('sparkle');
            const rect = ui.mascot.getBoundingClientRect();
            createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2);
        });
    }

    function toggleTheme() {
        const newTheme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) { ui.themeToggle.innerHTML = theme === 'light' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>'; }
    // --- End Mascot & Theme Toggle Logic ---

    // --- Floating Emojis Logic ---
    // Font Awesome icons for floating elements, including academic and stationery themes
    const floatingEmojis = [
        '<i class="fa-solid fa-chalkboard-user text-blue-500"></i>', // 教師與黑板
        '<i class="fa-solid fa-book-open text-purple-500"></i>', // 打開的書
        '<i class="fa-solid fa-lightbulb text-yellow-500"></i>', // 燈泡，點子
        '<i class="fa-solid fa-pencil text-red-500"></i>', // 鉛筆
        '<i class="fa-solid fa-calendar-alt text-green-500"></i>', // 日曆，時間
        '<i class="fa-solid fa-location-dot text-orange-500"></i>', // 地點
        '<i class="fa-solid fa-user-tie text-teal-500"></i>', // 專業人士
        '<i class="fa-solid fa-laptop-code text-indigo-500"></i>', // 程式碼或線上學習
        '<i class="fa-solid fa-comments text-pink-500"></i>', // 討論、交流
        '<i class="fa-solid fa-clock text-gray-500"></i>', // 時間、時數
        '<i class="fa-solid fa-certificate text-amber-500"></i>', // 證書、學分
        '<i class="fa-solid fa-bullhorn text-cyan-500"></i>', // 公告、通知
        '<i class="fa-solid fa-handshake-angle text-emerald-500"></i>', // 協助、合作
        '<i class="fa-solid fa-users text-violet-500"></i>', // 團隊、參與者
        '<i class="fa-solid fa-bell text-zinc-500"></i>', // 提醒、通知
        '<i class="fa-solid fa-graduation-cap text-blue-600"></i>', // 學位帽，教育
        '<i class="fa-solid fa-file-lines text-brown-500"></i>', // 文件
        '<i class="fa-solid fa-money-check-dollar text-lime-500"></i>', // 費用
    ];
    let emojiInterval;

    function createFloatingEmoji() {
        if (!ui.floatingEmojisContainer) return;

        const emojiEl = document.createElement('span');
        emojiEl.classList.add('floating-emoji');
        // 使用 innerHTML 來插入 Font Awesome 圖示
        emojiEl.innerHTML = floatingEmojis[Math.floor(Math.random() * floatingEmojis.length)];
        
        // Randomize initial position (start from bottom, across width)
        const startX = Math.random() * 100; // 0-100vw
        emojiEl.style.left = `${startX}vw`;
        emojiEl.style.bottom = `${-10 - Math.random() * 10}vh`; // Start slightly below screen

        // Randomize animation duration and delay
        const duration = 8 + Math.random() * 7; // 8 to 15 seconds
        const delay = Math.random() * 3; // 0 to 3 seconds delay
        emojiEl.style.animationDuration = `${duration}s`;
        emojiEl.style.animationDelay = `${delay}s`;
        
        // Randomize initial rotation for a more natural look
        const initialRotation = Math.random() * 360;
        emojiEl.style.transform = `translateY(0vh) scale(0.5) rotateZ(${initialRotation}deg)`;

        ui.floatingEmojisContainer.appendChild(emojiEl);

        // Remove emoji after animation finishes to prevent DOM clutter
        emojiEl.addEventListener('animationend', () => {
            emojiEl.remove();
        });
    }

    function startFloatingEmojis() {
        // Clear any existing interval to prevent duplicates
        if (emojiInterval) clearInterval(emojiInterval);
        // Create an emoji immediately, then every X seconds
        createFloatingEmoji(); 
        emojiInterval = setInterval(createFloatingEmoji, 1500 + Math.random() * 1000); // Create every 1.5-2.5 seconds
    }

    function stopFloatingEmojis() {
        if (emojiInterval) {
            clearInterval(emojiInterval);
            emojiInterval = null;
        }
        // Immediately remove all floating emojis
        if (ui.floatingEmojisContainer) {
            ui.floatingEmojisContainer.innerHTML = '';
        }
    }
    // --- End Floating Emojis Logic ---


    // Initial setup when the page loads
    function init() {
        // Load theme from localStorage, default to 'light'
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // 確保初始訊息也顯示在狀態日誌中
        logStatus('系統初始化完成，請上傳 PDF 或圖片檔案。', 'info');
        
        bindEvents();
        updateExtractionButtonState();
        showWelcomeScreen(); // This will now correctly use markdownOutput

        startFloatingEmojis(); // Start the background floating emojis
    }

    // Bind all event listeners
    function bindEvents() {
        ui.themeToggle.addEventListener('click', toggleTheme);

        // Drag and Drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => ui.dropZone.addEventListener(e, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(e => ui.dropZone.addEventListener(e, () => ui.dropZone.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(e => ui.dropZone.addEventListener(e, () => ui.dropZone.classList.remove('drag-over'), false));
        
        // Handle drop event: assign files to input and trigger change event
        ui.dropZone.addEventListener('drop', e => {
            if (e.dataTransfer.files.length > 0) {
                ui.fileUpload.files = e.dataTransfer.files; 
                const changeEvent = new Event('change');
                ui.fileUpload.dispatchEvent(changeEvent); // Manually dispatch change event
            }
        }, false);
        
        // Handle file input change (for both click and drop events)
        ui.fileUpload.addEventListener('change', e => {
            if (e.target.files.length > 0) {
                logActivity(state.currentUser.name, state.currentUser.role, '檔案上傳', `上傳 ${e.target.files.length} 個檔案`);
            }
            handleFiles(e.target.files);
            // Clear the input value to allow selecting the same file again
            e.target.value = ''; 
        });

        // Buttons
        ui.startExtractionBtn.addEventListener('click', startAiProcessing);
        ui.clearAllBtn.addEventListener('click', clearAll);
        ui.copyMarkdownBtn.addEventListener('click', () => {
            copyToClipboard(ui.markdownOutput.value, ui.copyMarkdownBtn);
            logActivity(state.currentUser.name, state.currentUser.role, '複製Markdown', '複製AI提取結果為Markdown');
        });

        // API Key Modal
        ui.openApiKeyModalLink.addEventListener('click', () => ui.apiKeyModal.style.display = 'flex');
        ui.closeApiKeyModalBtn.addEventListener('click', () => ui.apiKeyModal.style.display = 'none');
        ui.apiKeyModal.addEventListener('click', e => { if (e.target === ui.apiKeyModal) ui.apiKeyModal.style.display = 'none'; });
    }

    function preventDefaults(e) { 
        e.preventDefault(); 
        e.stopPropagation(); 
    }
    
    // Display welcome message in results panel (now using markdownOutput)
    function showWelcomeScreen() {
        ui.markdownOutput.value = `歡迎使用教師研習資訊神提取系統！
        
請將 PDF 或圖片檔案拖曳到左側的虛線框中，或點擊選擇檔案。
上傳檔案後，填入您的 Google Gemini API 金鑰，然後點擊「開始AI神提取」按鈕。
AI 會自動分析文件內容，並將提取到的教師研習資訊整理成 Markdown 格式顯示在這裡。

祝您研習業務順利，使用愉快！:)`;
        ui.markdownOutput.placeholder = 'AI 提取結果將以 Markdown 格式顯示於此，您可以編輯後複製...';
        ui.copyMarkdownBtn.style.display = 'none'; // Hide copy button initially
    }

    // Process selected files from input or drag/drop
    function handleFiles(files) {
        if (!files || files.length === 0) {
            logStatus('未選擇檔案或取消選擇。', 'info');
            return;
        }
        for (const file of files) {
            if (!file.type.includes('pdf') && !file.type.includes('image')) {
                logStatus(`錯誤：檔案 "${file.name}" 不是 PDF 或圖片格式，已忽略。`, 'error');
                continue;
            }
            const id = `file-${state.fileIdCounter++}`;
            state.files.set(id, { file, id, status: '等待處理', text: null, data: null });
            renderFileListItem(id);
            logStatus(`已加入檔案: ${file.name}`);
        }
        updateExtractionButtonState();
    }

    // Render a single file item in the file list
    function renderFileListItem(id) {
        const fileItem = state.files.get(id);
        const icon = fileItem.file.type.includes('pdf') ? 'fa-file-pdf' : 'fa-image';
        const newDiv = document.createElement('div');
        newDiv.id = `file-item-${id}`;
        newDiv.className = 'flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-sm';
        newDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icon} text-red-500 mr-3"></i>
                <span class="text-sm font-medium text-gray-800 dark:text-gray-100">${fileItem.file.name}</span>
            </div>
            <div class="flex items-center gap-2">
                <span id="file-status-${id}" class="text-xs text-gray-500 dark:text-gray-300">${fileItem.status}</span>
                <button data-file-id="${id}" class="remove-file-btn text-gray-400 hover:text-red-500 text-lg leading-none">&times;</button>
            </div>
        `;
        ui.fileList.appendChild(newDiv);

        newDiv.querySelector('.remove-file-btn').addEventListener('click', (e) => {
            const fileId = e.target.dataset.fileId;
            const removedFileName = state.files.get(fileId)?.file.name || '未知檔案';
            state.files.delete(fileId);
            document.getElementById(`file-item-${fileId}`).remove();
            logStatus(`已移除檔案: ${removedFileName}`);
            logActivity(state.currentUser.name, state.currentUser.role, '檔案移除', `移除檔案: ${removedFileName}`);
            updateExtractionButtonState();
            if (state.files.size === 0) {
                state.allExtractedResults = [];
                showWelcomeScreen(); // Go back to welcome if no files left
            }
        });
    }

    // Update status for a specific file item
    function updateFileStatus(id, status, type = 'info') {
        const fileItem = state.files.get(id);
        if (fileItem) {
            fileItem.status = status;
            const statusEl = document.getElementById(`file-status-${id}`);
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.className = `text-xs mr-2 ${
                    type === 'error' ? 'text-red-600 dark:text-red-300' :
                    type === 'success' ? 'text-green-600 dark:text-green-300' :
                    'text-gray-700 dark:text-gray-200' // Default info status text color
                }`;
            }
        }
    }

    // Enable/disable buttons based on file list state
    function updateExtractionButtonState() {
        ui.startExtractionBtn.disabled = state.files.size === 0;
        ui.clearAllBtn.disabled = state.files.size === 0;
        document.querySelectorAll('.remove-file-btn').forEach(btn => btn.disabled = (state.files.size === 0));
    }

    // Clear all uploaded files and results
    async function clearAll() {
        if (state.files.size === 0 && state.allExtractedResults.length === 0) return;
        const numFiles = state.files.size;
        state.files.clear();
        state.fileIdCounter = 0;
        ui.fileList.innerHTML = '';
        ui.fileUpload.value = null;
        state.allExtractedResults = []; // Clear extracted results too
        logStatus('所有檔案和結果已清空。');
        logActivity(state.currentUser.name, state.currentUser.role, '清除所有', `清空 ${numFiles} 個檔案和 AI 結果`);
        updateExtractionButtonState();
        showWelcomeScreen();
    }

    // Process a single file (PDF or Image) to extract text
    async function processFile(fileItem) {
        updateFileStatus(fileItem.id, '讀取中...');
        logStatus(`正在處理檔案: ${fileItem.file.name}`);
        let extractedText = '';

        try {
            if (fileItem.file.type.includes('pdf')) {
                const arrayBuffer = await fileItem.file.arrayBuffer();
                const pdf = await libraries.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                }
                extractedText = fullText.trim();
                if (extractedText) {
                    updateFileStatus(fileItem.id, 'PDF文字提取完成', 'success');
                } else {
                    updateFileStatus(fileItem.id, 'PDF未提取到文字 (可能是掃描圖檔)', 'error');
                    logStatus(`檔案 ${fileItem.file.name}: PDF 未提取到文字內容。可能是掃描文件，AI 提取可能受影響。`, 'error');
                }
            } else if (fileItem.file.type.includes('image')) {
                updateFileStatus(fileItem.id, 'OCR 識別中...');
                const { data: { text } } = await libraries.Tesseract.recognize(fileItem.file, 'chi_tra+eng'); // Supports Chinese and English
                extractedText = text.trim();
                updateFileStatus(fileItem.id, 'OCR 識別完成', 'success');
            }
        } catch (error) {
            updateFileStatus(fileItem.id, `讀取或OCR失敗: ${error.message}`, 'error');
            logStatus(`檔案 ${fileItem.file.name} 處理失敗: ${error.message}`, 'error');
            return null;
        }

        fileItem.text = extractedText;
        return extractedText;
    }

    // Start AI processing for all uploaded files
    async function startAiProcessing() {
        const apiKey = ui.apiKeyInput.value.trim();
        if (!apiKey) {
            logStatus('錯誤：請先輸入您的 Google Gemini API 金鑰。', 'error');
            ui.apiKeyInput.focus();
            return;
        }
        if (state.files.size === 0) {
            logStatus('錯誤：沒有可處理的檔案。', 'error');
            return;
        }

        setButtonsState(true);
        ui.startExtractionBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> AI 提取中...`;
        ui.markdownOutput.value = ''; // Clear previous results
        ui.markdownOutput.placeholder = '正在提取資訊...請稍候...';
        ui.copyMarkdownBtn.style.display = 'none';

        state.allExtractedResults = []; // Clear previous AI results
        let totalTrainingsExtracted = 0; // Changed variable name

        for (const fileItem of state.files.values()) {
            const extractedText = await processFile(fileItem);
            if (!extractedText) {
                logStatus(`檔案 ${fileItem.file.name} 未能提取到文字，跳過 AI 處理。`, 'error');
                continue;
            }
            if (extractedText.length < 50) { 
                 logStatus(`檔案 ${fileItem.file.name} 提取到的文字過短，可能影響 AI 結果。`, 'info');
            }

            updateFileStatus(fileItem.id, 'AI 分析中...');
            logStatus(`檔案 ${fileItem.file.name}: 正在聯繫 AI 進行資訊提取...`);

            try {
                const aiResponse = await callGeminiApi(generateTrainingPrompt(extractedText), apiKey); // Changed prompt function
                const parsedData = JSON.parse(aiResponse);

                const trainings = Array.isArray(parsedData) ? parsedData : (parsedData ? [parsedData] : []); // Changed variable name

                // Store full data, including original file name
                fileItem.data = trainings;
                state.allExtractedResults.push(...trainings.map(s => ({ ...s, sourceFile: fileItem.file.name }))); // Changed variable name
                totalTrainingsExtracted += trainings.length; // Changed variable name
                
                updateFileStatus(fileItem.id, 'AI 提取完成', 'success');
                logStatus(`檔案 ${fileItem.file.name}: AI 資訊提取成功。`, 'success');
                logActivity(state.currentUser.name, state.currentUser.role, 'AI提取成功', `檔案 "${fileItem.file.name}" AI提取完成，共 ${trainings.length} 筆資料`);

            } catch (error) {
                fileItem.data = { error: error.message };
                updateFileStatus(fileItem.id, `AI 提取失敗: ${error.message}`, 'error');
                logStatus(`檔案 ${fileItem.file.name} AI 提取失敗: ${error.message}`, 'error');
                logActivity(state.currentUser.name, state.currentUser.role, 'AI提取失敗', `檔案 "${fileItem.file.name}" AI提取失敗: ${error.message}`);
            }
        }

        updateMarkdownOutputArea(state.allExtractedResults); 
        setButtonsState(false);
        ui.startExtractionBtn.innerHTML = `<i class="fa-solid fa-brain"></i> 開始AI神提取`;
        logStatus(`所有檔案處理完畢。共提取到 ${totalTrainingsExtracted} 筆教師研習資訊。`, 'success'); // Changed message
    }

    // Call Google Gemini API
    async function callGeminiApi(prompt, apiKey) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: 0.1, 
                    maxOutputTokens: 2048
                }
            })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `API 請求失敗，狀態碼: ${response.status}`);
        }
        const data = await response.json();
        if (!data.candidates || data.candidates.length === 0) {
             throw new Error("API 未返回有效內容，可能被安全過濾器阻擋或沒有找到相關資訊。");
        }
        return data.candidates[0].content.parts[0].text;
    }

    // Generate prompt for AI extraction (UPDATED FOR TEACHER TRAINING)
    function generateTrainingPrompt(text) {
        return `你是一個專業的教師研習資訊提取助手。我將提供你從文件（PDF或圖片）中提取的純文字內容。你的任務是從這些文字中提取出特定的教師研習資訊。請注意，一份文件中可能包含一個或多個研習的資訊。

你需要提取以下所有相關欄位：
- **公文文號 (document_number)**: 該研習或通知的正式文件編號。如果沒有明確指出，請填寫 null。
- **研習名稱 (training_name)**: 研習的完整名稱。
- **研習對象及資格 (target_audience_eligibility)**: 研習參與者必須符合的所有條件，例如教師職稱、學科領域、學校層級等，請盡可能詳細但簡潔地列出，使用條列式。
- **研習地點 (training_location)**: 研習進行的地點（例如：線上會議室連結、具體地址、學校名稱）。如果沒有明確指出，請填寫 null。
- **研習時間 (training_dates)**: 研習的開始與結束日期及時間。請盡量提取具體日期和時間範圍 (格式 YYYY-MM-DD HH:MM)。如果僅有日期，格式 YYYY-MM-DD。如果沒有明確指出，請填寫 null。
- **報名截止日期 (registration_deadline)**: 報名參加研習的截止日期，請盡量提取具體日期 (格式 YYYY-MM-DD)。如果沒有明確指出，請填寫 null。
- **主辦單位 (organizer)**: 舉辦或協辦此研習的單位名稱。
- **聯絡資訊 (contact_info)**: 研習相關的聯絡人、電話、電子郵件或其他聯絡方式。
- **研習時數或學分 (hours_credits)**: 完成研習後可獲得的研習時數或學分。
- **報名費用 (registration_fee)**: 參加研習所需的費用，若免費請註明「免費」。
- **注意事項 (notes)**: 其他重要的研習資訊或說明，例如攜帶物品、報到方式等。

請嚴格以 JSON 陣列的格式返回結果。陣列中的每個物件代表一個研習的完整資訊。如果某個欄位資訊在原文中不存在，請填寫 \`null\`。請確保 JSON 格式正確無誤。

範例 JSON 輸出格式：
\`\`\`json
[
  {
    "document_number": "研習字第1130801001號",
    "training_name": "AI融入教學創新應用工作坊",
    "target_audience_eligibility": [
      "全國國民中小學在職教師",
      "對AI教學應用有興趣者優先",
      "需具備基礎電腦操作能力"
    ],
    "training_location": "國立臺灣師範大學 教育學院501會議室",
    "training_dates": "2024-09-10 09:00-16:00",
    "registration_deadline": "2024-08-31",
    "organizer": "教育部資訊及科技教育司",
    "contact_info": "李老師 (02)1234-5678, teacher.li@example.com",
    "hours_credits": "研習時數 6 小時",
    "registration_fee": "免費",
    "notes": "請自備筆記型電腦及充電設備。"
  },
  {
    "document_number": null,
    "training_name": "線上班級經營策略研討會",
    "target_audience_eligibility": [
      "幼兒園、國小教師",
      "對線上教學有困擾的教師",
      "不限資歷"
    ],
    "training_location": "Google Meet 線上會議 (連結將於報名後提供)",
    "training_dates": "2024-10-20 14:00-17:00",
    "registration_deadline": "2024-10-15",
    "organizer": "臺灣教育研究院",
    "contact_info": "報名組 (02)9876-5432",
    "hours_credits": "3 學分",
    "registration_fee": "新台幣 500 元",
    "notes": null
  }
]
\`\`\`

以下是從文件提取的文字內容：
---\n${text}\n---`;
    }

    // Helper to format date strings for display (client-side)
    function formatDate(dateString) {
        if (!dateString || dateString.toLowerCase() === 'null' || dateString === '無' || dateString === '') return '無'; // Just return "無" string for Markdown
        try {
            // Attempt to parse various date-time formats, prioritizing YYYY-MM-DD
            const matchDateOnly = dateString.match(/(\d{4}-\d{2}-\d{2})/);
            if (matchDateOnly) {
                const date = new Date(matchDateOnly[1]);
                if (!isNaN(date.getTime())) {
                    return matchDateOnly[1]; // Return YYYY-MM-DD
                }
            }
            
            // If date-only failed or not found, try to return as is if it looks like a date range
            const matchDateTime = dateString.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}-\d{2}:\d{2})/);
            if (matchDateTime) {
                return dateString; // Return date-time range as is
            }
            
            // Fallback: Try a general date parse, then return original if invalid
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) { 
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return dateString; // Return original string if not a valid date
        } catch (e) {
            console.error("Error formatting date:", dateString, e);
            return dateString;
        }
    }


    // Generates a Markdown string for a single training item (UPDATED FOR TEACHER TRAINING)
    function formatSingleTrainingAsMarkdown(data, index) {
        let markdown = `## 🍎📚 第 ${index + 1} 筆教師研習資訊 ✍️📅\n\n`; // Changed title and icons
        markdown += `--- \n`;
        markdown += `✨ **研習名稱**: ${data.training_name || '無'}\n`;
        markdown += `📄 **公文文號**: ${data.document_number || '無'}\n`;
        markdown += `🙋‍♀️ **研習對象及資格**:\n`; // Changed icon and field name
        if (Array.isArray(data.target_audience_eligibility) && data.target_audience_eligibility.length > 0) {
            data.target_audience_eligibility.forEach(item => {
                markdown += `  - ${item}\n`;
            });
        } else {
            markdown += `  - 無\n`;
        }
        markdown += `📍 **研習地點**: ${data.training_location || '無'}\n`; // Changed icon and field name
        markdown += `⏰ **研習時間**: ${data.training_dates || '無'}\n`; // Changed icon and field name
        markdown += `📝 **報名截止日期**: ${formatDate(data.registration_deadline) || '無'}\n`; // Changed icon and field name
        markdown += `🏢 **主辦單位**: ${data.organizer || '無'}\n`; // Changed icon and field name
        markdown += `📞 **聯絡資訊**: ${data.contact_info || '無'}\n`; // Changed icon and field name
        markdown += `🎓 **研習時數或學分**: ${data.hours_credits || '無'}\n`; // Changed icon and field name
        markdown += `💲 **報名費用**: ${data.registration_fee || '無'}\n`; // Changed icon and field name
        markdown += `⚠️ **注意事項**: ${data.notes || '無'}\n`; // Changed icon and field name
        markdown += `📁 **來源檔案**: _${data.sourceFile || '無'}_\n`;
        markdown += `--- \n\n`;
        return markdown;
    }


    // Updates the markdown output area with all extracted results
    function updateMarkdownOutputArea(results) {
        if (results.length === 0) {
            ui.markdownOutput.value = '';
            ui.markdownOutput.placeholder = '未能從檔案中提取到任何教師研習資訊。'; // Changed message
            ui.copyMarkdownBtn.style.display = 'none';
            return;
        }

        let fullMarkdown = '';
        results.forEach((item, index) => {
            fullMarkdown += formatSingleTrainingAsMarkdown(item, index); // Changed function call
        });

        ui.markdownOutput.value = fullMarkdown;
        ui.markdownOutput.placeholder = 'AI 提取結果已顯示於此，您可以編輯後複製...';
        ui.copyMarkdownBtn.style.display = 'inline-flex'; // Show copy button
    }


    // Helper function for copy to clipboard with visual feedback
    function copyToClipboard(text, buttonElement) {
        navigator.clipboard.writeText(text).then(() => {
            const originalIconHtml = buttonElement.innerHTML;
            const originalClasses = Array.from(buttonElement.classList);

            buttonElement.innerHTML = `<i class="fas fa-check"></i> 複製成功!`; 
            buttonElement.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white'); 
            buttonElement.classList.remove(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 

            setTimeout(() => {
                buttonElement.innerHTML = originalIconHtml; 
                buttonElement.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white'); 
                buttonElement.classList.add(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 
            }, 1500);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            const originalIconHtml = buttonElement.innerHTML;
            const originalClasses = Array.from(buttonElement.classList);

            buttonElement.innerHTML = `<i class="fas fa-times"></i> 複製失敗!`; 
            buttonElement.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white'); 
            buttonElement.classList.remove(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 
            
            setTimeout(() => {
                buttonElement.innerHTML = originalIconHtml; 
                buttonElement.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white'); 
                buttonElement.classList.add(...originalClasses.filter(cls => cls.startsWith('btn-secondary-custom'))); 
            }, 1500);
        });
    }

    // Logging function for client-side demo (outputs to status log and console)
    function logStatus(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
        const logEntry = document.createElement('p');
        
        logEntry.className = `py-1`; 
        
        let messageTextColorClass = 'text-gray-700 dark:text-gray-200'; // Default text color for general info
        if (type === 'error') {
            messageTextColorClass = 'text-red-600 dark:text-red-300'; // Specific brighter color for errors in dark mode
        } else if (type === 'success') {
            messageTextColorClass = 'text-green-600 dark:text-green-300'; // Specific brighter color for success in dark mode
        }

        // Apply timestamp color and then message color
        logEntry.innerHTML = `<span class="text-gray-500 dark:text-gray-400">[${timestamp}]</span> <span class="${messageTextColorClass}">&gt; ${message}</span>`;
        ui.statusLog.appendChild(logEntry);
        ui.statusLog.scrollTop = ui.statusLog.scrollHeight; // Auto-scroll to bottom
        
        // Also log to console for debugging
        if (type === 'error') console.error(`[STATUS] ${message}`);
        else if (type === 'success') console.log(`[STATUS] ${message}`);
        else console.info(`[STATUS] ${message}`);
    }

    // Logging function for client-side demo (outputs to console only) - separate from status log
    function logActivity(userName, userRole, activityType, description) {
        const timestamp = new Date().toLocaleString('zh-TW', { hour12: false });
        console.log(`[ACTIVITY LOG - Frontend] ${timestamp} | User: ${userName} (${userRole}) | Type: ${activityType} | Desc: ${description}`);
    }
    
    // Helper to set buttons state (disabled/enabled)
    function setButtonsState(processing) {
        ui.fileUpload.disabled = processing;
        ui.startExtractionBtn.disabled = processing || state.files.size === 0;
        ui.clearAllBtn.disabled = processing;
        document.querySelectorAll('.remove-file-btn').forEach(btn => btn.disabled = processing);
    }

    // Call init when the DOM is fully loaded
    init();
});
</script>

</body>
</html>